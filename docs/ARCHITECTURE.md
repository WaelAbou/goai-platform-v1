# GoAI Sovereign AI Platform — Architecture Diagrams  

## Diagram Index

| # | Diagram | Description |
|---|---------|-------------|
| 1 | [High-Level Architecture](#1-high-level-architecture) | System overview |
| 2 | [Layered Architecture](#2-layered-architecture-sovereign-stack) | 5-layer sovereign stack |
| 3 | [Data Flow](#3-data-flow-diagram) | Request processing |
| 4 | [RAG Retrieval Flow](#4-rag-retrieval-flow) | Document retrieval |
| 5 | [Multi-Agent Orchestration](#5-multi-agent-orchestration) | Agent collaboration |
| 6 | [Deployment Topology](#6-deployment-topology) | Node architecture |
| 7 | [RBAC + ACL Flow](#7-rbac--acl-flow) | Authorization |
| 8 | [Monitoring Pipeline](#8-monitoring-pipeline) | Observability |

---

## 1. High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│                        GoAI SOVEREIGN AI PLATFORM                                    │
│                           High-Level Architecture                                    │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                              CLIENTS                                         │   │
│   │                                                                              │   │
│   │    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐               │   │
│   │    │   Web   │    │ Mobile  │    │   API   │    │   SDK   │               │   │
│   │    │ Console │    │   App   │    │ Clients │    │ Clients │               │   │
│   │    └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘               │   │
│   │         │              │              │              │                     │   │
│   │         └──────────────┴──────────────┴──────────────┘                     │   │
│   │                                 │                                          │   │
│   └─────────────────────────────────┼──────────────────────────────────────────┘   │
│                                     │                                              │
│                                     ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                          LOAD BALANCER / WAF                                 │  │
│   │                          (NGINX + ModSecurity)                               │  │
│   └─────────────────────────────────┬───────────────────────────────────────────┘  │
│                                     │                                              │
│                                     ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                              API GATEWAY                                     │  │
│   │                                                                              │  │
│   │   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐              │  │
│   │   │   Auth    │  │   Rate    │  │   Audit   │  │  Metrics  │              │  │
│   │   │ (Keycloak)│  │  Limiter  │  │  Logger   │  │ (Prom)    │              │  │
│   │   └───────────┘  └───────────┘  └───────────┘  └───────────┘              │  │
│   │                                                                              │  │
│   └─────────────────────────────────┬───────────────────────────────────────────┘  │
│                                     │                                              │
│            ┌────────────────────────┼────────────────────────┐                     │
│            │                        │                        │                     │
│            ▼                        ▼                        ▼                     │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│   │  RAG SERVICE    │    │  AGENT SERVICE  │    │  OTHER SERVICES │              │
│   │                 │    │                 │    │                 │              │
│   │  • Query        │    │  • Single Agent │    │  • Memory       │              │
│   │  • Ingest       │    │  • Multi-Agent  │    │  • Feedback     │              │
│   │  • Search       │    │  • Tools        │    │  • Export       │              │
│   │                 │    │                 │    │  • Workflows    │              │
│   └────────┬────────┘    └────────┬────────┘    └────────┬────────┘              │
│            │                      │                      │                        │
│            └──────────────────────┼──────────────────────┘                        │
│                                   │                                               │
│                                   ▼                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────┐ │
│   │                          CORE SERVICES                                       │ │
│   │                                                                              │ │
│   │   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐              │ │
│   │   │    LLM    │  │  Vector   │  │   Auth    │  │ Streaming │              │ │
│   │   │  Router   │  │   Store   │  │  Service  │  │  Engine   │              │ │
│   │   └─────┬─────┘  └─────┬─────┘  └───────────┘  └───────────┘              │ │
│   │         │              │                                                   │ │
│   └─────────┼──────────────┼───────────────────────────────────────────────────┘ │
│             │              │                                                      │
│             ▼              ▼                                                      │
│   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │
│   │  GPU CLUSTER    │  │   FAISS INDEX   │  │   POSTGRESQL    │                 │
│   │                 │  │                 │  │                 │                 │
│   │  ┌─────┐┌─────┐ │  │  500K+ vectors  │  │  Users, Docs,   │                 │
│   │  │vLLM ││vLLM │ │  │                 │  │  Audit, ACL     │                 │
│   │  │ 70B ││  8B │ │  │                 │  │                 │                 │
│   │  └─────┘└─────┘ │  │                 │  │                 │                 │
│   └─────────────────┘  └─────────────────┘  └─────────────────┘                 │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Layered Architecture (Sovereign Stack)

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                               │
│                                    GoAI SOVEREIGN AI PLATFORM v1                                             │
│                                    ═══════════════════════════════                                            │
│                                                                                                               │
│  ╔════════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                                    LAYER 5: OPERATIONS                                                  ║  │
│  ║                                                                                                         ║  │
│  ║   ┌────────────────┐   ┌────────────────┐   ┌────────────────┐   ┌────────────────┐                   ║  │
│  ║   │   Prometheus   │   │    Grafana     │   │  Alertmanager  │   │   Log Agg      │                   ║  │
│  ║   │   (Metrics)    │   │  (Dashboards)  │   │   (Alerts)     │   │   (ELK/Loki)   │                   ║  │
│  ║   └────────────────┘   └────────────────┘   └────────────────┘   └────────────────┘                   ║  │
│  ║                                                                                                         ║  │
│  ║   ┌────────────────┐   ┌────────────────┐   ┌────────────────┐   ┌────────────────┐                   ║  │
│  ║   │    Backups     │   │  Blue/Green    │   │    Rollback    │   │  Disaster      │                   ║  │
│  ║   │   (Nightly)    │   │   Deployment   │   │   Automation   │   │  Recovery      │                   ║  │
│  ║   └────────────────┘   └────────────────┘   └────────────────┘   └────────────────┘                   ║  │
│  ╚════════════════════════════════════════════════════════════════════════════════════════════════════════╝  │
│                                                     │                                                         │
│  ╔════════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                                    LAYER 4: APPLICATIONS                                                ║  │
│  ║                                                                                                         ║  │
│  ║   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║   │                              MICROSERVICES (Use Case Implementations)                            │ ║  │
│  ║   │                                                                                                   │ ║  │
│  ║   │   ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          │ ║  │
│  ║   │   │   RAG Chat   │ │   Policy     │ │    CVM       │ │  Document    │ │   Ticket     │          │ ║  │
│  ║   │   │   Pattern    │ │  Assistant   │ │   Insight    │ │  Validator   │ │  Analyzer    │          │ ║  │
│  ║   │   │              │ │   Pattern    │ │   Pattern    │ │   Pattern    │ │   Pattern    │          │ ║  │
│  ║   │   │  • Q&A       │ │              │ │              │ │              │ │              │          │ ║  │
│  ║   │   │  • Citations │ │  • Strict    │ │  • SQL Gen   │ │  • Rules     │ │  • Sentiment │          │ ║  │
│  ║   │   │  • Multi-turn│ │    Citations │ │  • Analytics │ │  • LLM QA    │ │  • Priority  │          │ ║  │
│  ║   │   │  • Streaming │ │  • Confidence│ │  • Charts    │ │  • Fact-check│ │  • Category  │          │ ║  │
│  ║   │   └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘          │ ║  │
│  ║   │                                                                                                   │ ║  │
│  ║   └──────────────────────────────────────────────────────────────────────────────────────────────────┘ ║  │
│  ╚════════════════════════════════════════════════════════════════════════════════════════════════════════╝  │
│                                                     │                                                         │
│  ╔════════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                                    LAYER 3: KNOWLEDGE                                                   ║  │
│  ║                                                                                                         ║  │
│  ║   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║   │                                 INGESTION PIPELINE                                                │ ║  │
│  ║   │                                                                                                   │ ║  │
│  ║   │   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐                  │ ║  │
│  ║   │   │  Upload  │───▶│  Extract │───▶│  Chunk   │───▶│  Embed   │───▶│  Index   │                  │ ║  │
│  ║   │   │  Files   │    │  Text    │    │  512tok  │    │  BGE     │    │  FAISS   │                  │ ║  │
│  ║   │   └──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘                  │ ║  │
│  ║   │                                                                                                   │ ║  │
│  ║   │   Supported: PDF, DOCX, XLSX, PPTX, TXT, MD, HTML, CSV                                           │ ║  │
│  ║   └──────────────────────────────────────────────────────────────────────────────────────────────────┘ ║  │
│  ║                                                                                                         ║  │
│  ║   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║   │                               RETRIEVAL & ACCESS CONTROL                                          │ ║  │
│  ║   │                                                                                                   │ ║  │
│  ║   │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                      │ ║  │
│  ║   │   │    FAISS     │   │     ACL      │   │  Retrieval   │   │   Metadata   │                      │ ║  │
│  ║   │   │  IVF+PQ      │   │  Per-Doc     │   │   Auditor    │   │   Store      │                      │ ║  │
│  ║   │   │  1024-dim    │   │  User/Group  │   │   (Postgres) │   │   (Postgres) │                      │ ║  │
│  ║   │   └──────────────┘   └──────────────┘   └──────────────┘   └──────────────┘                      │ ║  │
│  ║   └──────────────────────────────────────────────────────────────────────────────────────────────────┘ ║  │
│  ╚════════════════════════════════════════════════════════════════════════════════════════════════════════╝  │
│                                                     │                                                         │
│  ╔════════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                                    LAYER 2: GATEWAY                                                     ║  │
│  ║                                                                                                         ║  │
│  ║   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║   │                                   FASTAPI GATEWAY                                                 │ ║  │
│  ║   │                                                                                                   │ ║  │
│  ║   │   Request ──▶ NGINX ──▶ Middleware Stack ──▶ Router ──▶ Handler                                  │ ║  │
│  ║   │                              │                                                                    │ ║  │
│  ║   │                              ▼                                                                    │ ║  │
│  ║   │              ┌────────────────────────────────┐                                                   │ ║  │
│  ║   │              │     Middleware Pipeline        │                                                   │ ║  │
│  ║   │              │  1. CORS                       │                                                   │ ║  │
│  ║   │              │  2. Request ID                 │                                                   │ ║  │
│  ║   │              │  3. Keycloak Auth (RBAC)       │                                                   │ ║  │
│  ║   │              │  4. Rate Limiter               │                                                   │ ║  │
│  ║   │              │  5. Audit Logger (Postgres)    │                                                   │ ║  │
│  ║   │              │  6. Prometheus Metrics         │                                                   │ ║  │
│  ║   │              │  7. Error Handler              │                                                   │ ║  │
│  ║   │              └────────────────────────────────┘                                                   │ ║  │
│  ║   └──────────────────────────────────────────────────────────────────────────────────────────────────┘ ║  │
│  ║                                                                                                         ║  │
│  ║   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐        ║  │
│  ║   │   Keycloak   │   │    Rate      │   │    Audit     │   │  Prometheus  │   │     API      │        ║  │
│  ║   │     RBAC     │   │   Limiter    │   │   Logger     │   │   Exporter   │   │  Contracts   │        ║  │
│  ║   │              │   │              │   │              │   │              │   │   (OpenAPI)  │        ║  │
│  ║   │  admin       │   │  Unlimited   │   │  All reqs    │   │  /metrics    │   │              │        ║  │
│  ║   │  operator    │   │  1000/min    │   │  to Postgres │   │  http_*      │   │  Versioned   │        ║  │
│  ║   │  power_user  │   │  100/min     │   │  Sanitized   │   │  llm_*       │   │  /api/v1/*   │        ║  │
│  ║   │  user        │   │  20/min      │   │  Partitioned │   │  rag_*       │   │              │        ║  │
│  ║   └──────────────┘   └──────────────┘   └──────────────┘   └──────────────┘   └──────────────┘        ║  │
│  ╚════════════════════════════════════════════════════════════════════════════════════════════════════════╝  │
│                                                     │                                                         │
│  ╔════════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                                    LAYER 1: INFERENCE                                                   ║  │
│  ║                                                                                                         ║  │
│  ║   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║   │                                   GPU INFRASTRUCTURE                                              │ ║  │
│  ║   │                                                                                                   │ ║  │
│  ║   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │ ║  │
│  ║   │   │  NVIDIA L40S    │  │  Intel Gaudi2   │  │  Huawei Ascend  │  │    AMD MI300    │             │ ║  │
│  ║   │   │  48GB VRAM      │  │  96GB HBM       │  │  64GB HBM       │  │  192GB HBM      │             │ ║  │
│  ║   │   │  Tensor Cores   │  │  Habana Labs    │  │  AI Core        │  │  CDNA 3         │             │ ║  │
│  ║   │   └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘             │ ║  │
│  ║   │                                                                                                   │ ║  │
│  ║   │   Recommended: 4x L40S for Llama-70B | 8x L40S for Llama-405B                                    │ ║  │
│  ║   └──────────────────────────────────────────────────────────────────────────────────────────────────┘ ║  │
│  ║                                                                                                         ║  │
│  ║   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║   │                                  INFERENCE CONTAINERS                                             │ ║  │
│  ║   │                                                                                                   │ ║  │
│  ║   │   ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐                           │ ║  │
│  ║   │   │      vLLM        │    │       TGI        │    │     Ollama       │                           │ ║  │
│  ║   │   │   (Production)   │    │   (Alternative)  │    │   (Dev Only)     │                           │ ║  │
│  ║   │   │                  │    │                  │    │                  │                           │ ║  │
│  ║   │   │  • Paged Attn    │    │  • Flash Attn    │    │  • Easy Setup    │                           │ ║  │
│  ║   │   │  • Tensor Par    │    │  • Quantization  │    │  • Local Models  │                           │ ║  │
│  ║   │   │  • Continuous    │    │  • Watermarking  │    │  • CPU Fallback  │                           │ ║  │
│  ║   │   │    Batching      │    │                  │    │                  │                           │ ║  │
│  ║   │   └──────────────────┘    └──────────────────┘    └──────────────────┘                           │ ║  │
│  ║   └──────────────────────────────────────────────────────────────────────────────────────────────────┘ ║  │
│  ║                                                                                                         ║  │
│  ║   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║   │                                   MODEL MANAGEMENT                                                │ ║  │
│  ║   │                                                                                                   │ ║  │
│  ║   │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                      │ ║  │
│  ║   │   │    Model     │   │    Model     │   │    Model     │   │    Model     │                      │ ║  │
│  ║   │   │   Registry   │   │    Router    │   │    Health    │   │   Metrics    │                      │ ║  │
│  ║   │   │              │   │              │   │              │   │              │                      │ ║  │
│  ║   │   │  llama-70b   │   │  Load Bal    │   │  /health     │   │  TPS: 50-100 │                      │ ║  │
│  ║   │   │  llama-8b    │   │  Priority    │   │  GPU Util    │   │  TTFT: 200ms │                      │ ║  │
│  ║   │   │  mistral-7b  │   │  Fallback    │   │  Queue Size  │   │  Queue: <100 │                      │ ║  │
│  ║   │   └──────────────┘   └──────────────┘   └──────────────┘   └──────────────┘                      │ ║  │
│  ║   └──────────────────────────────────────────────────────────────────────────────────────────────────┘ ║  │
│  ╚════════════════════════════════════════════════════════════════════════════════════════════════════════╝  │
│                                                     │                                                         │
│  ╔════════════════════════════════════════════════════════════════════════════════════════════════════════╗  │
│  ║                                    DATA STORES                                                          ║  │
│  ║                                                                                                         ║  │
│  ║   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐        ║  │
│  ║   │  PostgreSQL  │   │    FAISS     │   │    Redis     │   │    MinIO     │   │Elasticsearch │        ║  │
│  ║   │              │   │              │   │              │   │              │   │              │        ║  │
│  ║   │  • Users     │   │  • Vectors   │   │  • Sessions  │   │  • Files     │   │  • Logs      │        ║  │
│  ║   │  • Audit     │   │  • IVF+PQ    │   │  • Cache     │   │  • Models    │   │  • Search    │        ║  │
│  ║   │  • Metadata  │   │  • 1024-dim  │   │  • Rate Lim  │   │  • Backups   │   │  • Analytics │        ║  │
│  ║   │  • ACL       │   │              │   │              │   │              │   │              │        ║  │
│  ║   └──────────────┘   └──────────────┘   └──────────────┘   └──────────────┘   └──────────────┘        ║  │
│  ╚════════════════════════════════════════════════════════════════════════════════════════════════════════╝  │
│                                                                                                               │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Request Flow Diagram

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                         REQUEST FLOW                                                          │
├──────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                               │
│   User Request                                                                                                │
│        │                                                                                                      │
│        ▼                                                                                                      │
│   ┌─────────┐                                                                                                │
│   │  NGINX  │  TLS Termination, Load Balancing                                                               │
│   └────┬────┘                                                                                                │
│        │                                                                                                      │
│        ▼                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    FastAPI Gateway                                                   │   │
│   │                                                                                                      │   │
│   │   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐              │   │
│   │   │  CORS   │──▶│ Req ID  │──▶│Keycloak │──▶│  Rate   │──▶│  Audit  │──▶│ Metrics │──▶ Router   │   │
│   │   └─────────┘   └─────────┘   │  Auth   │   │ Limiter │   │ Logger  │   └─────────┘              │   │
│   │                               └────┬────┘   └────┬────┘   └────┬────┘                            │   │
│   │                                    │             │             │                                  │   │
│   │                               401 Unauth    429 Limited    Log to PG                             │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│        │                                                                                                      │
│        ▼                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    Application Services                                              │   │
│   │                                                                                                      │   │
│   │   ┌───────────────────────────────────────────────────────────────────────────────────────────────┐ │   │
│   │   │                                   RAG Query Flow                                               │ │   │
│   │   │                                                                                                │ │   │
│   │   │   Query ──▶ Embed Query ──▶ FAISS Search ──▶ ACL Filter ──▶ Build Context ──▶ LLM Call       │ │   │
│   │   │                                                                     │                          │ │   │
│   │   │                                                              Memory Context                    │ │   │
│   │   │                                                                     │                          │ │   │
│   │   │                                                                     ▼                          │ │   │
│   │   │                                                              Streaming Response               │ │   │
│   │   │                                                                     │                          │ │   │
│   │   │                                                              Audit Retrieval                  │ │   │
│   │   │                                                                                                │ │   │
│   │   └───────────────────────────────────────────────────────────────────────────────────────────────┘ │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│        │                                                                                                      │
│        ▼                                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    Inference Layer                                                   │   │
│   │                                                                                                      │   │
│   │   ┌───────────────────────────────────────────────────────────────────────────────────────────────┐ │   │
│   │   │                                   vLLM Serving                                                 │ │   │
│   │   │                                                                                                │ │   │
│   │   │   Prompt ──▶ Tokenize ──▶ Paged Attention ──▶ KV Cache ──▶ Decode ──▶ Stream Tokens          │ │   │
│   │   │                              │                                                                 │ │   │
│   │   │                         Tensor Parallel                                                        │ │   │
│   │   │                         (4x GPU sharding)                                                      │ │   │
│   │   │                                                                                                │ │   │
│   │   └───────────────────────────────────────────────────────────────────────────────────────────────┘ │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│        │                                                                                                      │
│        ▼                                                                                                      │
│   Response with Citations + Sources + Metrics                                                                │
│                                                                                                               │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Architecture

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                         DATA ARCHITECTURE                                                     │
├──────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    PostgreSQL (Primary Store)                                        │   │
│   │                                                                                                      │   │
│   │   ┌────────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  users                    │  documents                │  document_acl                      │   │   │
│   │   │  ──────                   │  ─────────                │  ────────────                      │   │   │
│   │   │  id UUID PK               │  id UUID PK               │  id UUID PK                        │   │   │
│   │   │  email VARCHAR            │  filename VARCHAR         │  document_id UUID FK               │   │   │
│   │   │  password_hash VARCHAR    │  content_hash VARCHAR     │  principal_type VARCHAR            │   │   │
│   │   │  role VARCHAR             │  owner_id UUID FK         │  principal_id VARCHAR              │   │   │
│   │   │  created_at TIMESTAMP     │  visibility VARCHAR       │  permission VARCHAR                │   │   │
│   │   │                           │  chunk_count INT          │  granted_by UUID                   │   │   │
│   │   │                           │  created_at TIMESTAMP     │  expires_at TIMESTAMP              │   │   │
│   │   └────────────────────────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                                                      │   │
│   │   ┌────────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  audit_logs (Partitioned)      │  retrieval_audit               │  feedback                │   │   │
│   │   │  ─────────────────────────     │  ───────────────               │  ────────                │   │   │
│   │   │  id UUID PK                    │  id UUID PK                    │  id UUID PK              │   │   │
│   │   │  timestamp TIMESTAMPTZ         │  user_id UUID                  │  message_id UUID         │   │   │
│   │   │  request_id VARCHAR            │  query_text TEXT               │  user_id UUID            │   │   │
│   │   │  user_id UUID                  │  documents_retrieved JSONB     │  rating VARCHAR          │   │   │
│   │   │  method VARCHAR                │  response_generated BOOLEAN    │  comment TEXT            │   │   │
│   │   │  path TEXT                     │  retrieval_time_ms INT         │  created_at TIMESTAMP    │   │   │
│   │   │  request_body JSONB            │                                │                          │   │   │
│   │   │  response_status INT           │                                │                          │   │   │
│   │   │  response_time_ms INT          │                                │                          │   │   │
│   │   │  tokens_used INT               │                                │                          │   │   │
│   │   └────────────────────────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    FAISS (Vector Store)                                              │   │
│   │                                                                                                      │   │
│   │   Index Structure: IVF4096,PQ64                                                                     │   │
│   │   Dimensions: 1024                                                                                   │   │
│   │   Metric: Cosine Similarity                                                                         │   │
│   │                                                                                                      │   │
│   │   ┌────────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  Namespaces                                                                                │   │   │
│   │   │  ──────────                                                                                │   │   │
│   │   │                                                                                            │   │   │
│   │   │   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐           │   │   │
│   │   │   │   global     │    │  policies    │    │   legal      │    │     hr       │           │   │   │
│   │   │   │   (500K)     │    │   (50K)      │    │   (30K)      │    │   (20K)      │           │   │   │
│   │   │   └──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘           │   │   │
│   │   │                                                                                            │   │   │
│   │   └────────────────────────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                                                      │   │
│   │   Files:                                                                                             │   │
│   │   ├── indexes/global.faiss                                                                          │   │
│   │   ├── indexes/global.pkl (ID mapping)                                                               │   │
│   │   ├── indexes/policies.faiss                                                                        │   │
│   │   └── indexes/metadata.json                                                                         │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    Redis (Cache & Sessions)                                          │   │
│   │                                                                                                      │   │
│   │   Key Patterns:                                                                                      │   │
│   │   • session:{user_id} → User session data (TTL: 24h)                                                │   │
│   │   • rate:{user_id}:requests → Request count (TTL: 60s)                                              │   │
│   │   • rate:{user_id}:tokens → Token count (TTL: 60s)                                                  │   │
│   │   • cache:embed:{hash} → Cached embeddings (TTL: 1h)                                                │   │
│   │   • cache:llm:{hash} → Cached LLM responses (TTL: 5m)                                               │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    MinIO/S3 (Object Storage)                                         │   │
│   │                                                                                                      │   │
│   │   Buckets:                                                                                           │   │
│   │   • goai-documents/    → Uploaded files                                                              │   │
│   │   • goai-models/       → Model weights                                                               │   │
│   │   • goai-backups/      → Database backups                                                            │   │
│   │   • goai-exports/      → User exports                                                                │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                               │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Security Architecture

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                        SECURITY ARCHITECTURE                                                  │
├──────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    NETWORK SECURITY                                                  │   │
│   │                                                                                                      │   │
│   │   Internet ──▶ WAF ──▶ Load Balancer ──▶ NGINX (TLS 1.3) ──▶ Internal Network                       │   │
│   │                                                                │                                     │   │
│   │                                              ┌─────────────────┴─────────────────┐                  │   │
│   │                                              │         Firewall Rules            │                  │   │
│   │                                              │  • Only 443 exposed externally    │                  │   │
│   │                                              │  • Internal services on VPC       │                  │   │
│   │                                              │  • GPU nodes isolated             │                  │   │
│   │                                              └───────────────────────────────────┘                  │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    AUTHENTICATION & AUTHORIZATION                                    │   │
│   │                                                                                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │   │
│   │   │                                Keycloak RBAC                                                 │  │   │
│   │   │                                                                                              │  │   │
│   │   │   ┌──────────────┐                                                                          │  │   │
│   │   │   │    admin     │ ─── Full system access, user management                                  │  │   │
│   │   │   └──────┬───────┘                                                                          │  │   │
│   │   │          │                                                                                   │  │   │
│   │   │   ┌──────┴───────┐                                                                          │  │   │
│   │   │   │   operator   │ ─── Model deployment, monitoring, no user data                           │  │   │
│   │   │   └──────┬───────┘                                                                          │  │   │
│   │   │          │                                                                                   │  │   │
│   │   │   ┌──────┴───────┐                                                                          │  │   │
│   │   │   │  power_user  │ ─── All AI features, high rate limits, document management               │  │   │
│   │   │   └──────┬───────┘                                                                          │  │   │
│   │   │          │                                                                                   │  │   │
│   │   │   ┌──────┴───────┐                                                                          │  │   │
│   │   │   │     user     │ ─── Standard AI features, normal rate limits                             │  │   │
│   │   │   └──────┬───────┘                                                                          │  │   │
│   │   │          │                                                                                   │  │   │
│   │   │   ┌──────┴───────┐                                                                          │  │   │
│   │   │   │   readonly   │ ─── View only, no generation                                             │  │   │
│   │   │   └──────────────┘                                                                          │  │   │
│   │   │                                                                                              │  │   │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────────┘  │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    DATA SECURITY                                                     │   │
│   │                                                                                                      │   │
│   │   Encryption at Rest:                                                                                │   │
│   │   • PostgreSQL: AES-256 (pgcrypto)                                                                  │   │
│   │   • FAISS indexes: Encrypted volume                                                                 │   │
│   │   • MinIO: Server-side encryption (SSE-S3)                                                          │   │
│   │   • Redis: In-memory (no persistence) or encrypted RDB                                              │   │
│   │                                                                                                      │   │
│   │   Encryption in Transit:                                                                             │   │
│   │   • TLS 1.3 for all external connections                                                            │   │
│   │   • mTLS for internal service-to-service                                                            │   │
│   │                                                                                                      │   │
│   │   Document ACL:                                                                                      │   │
│   │   • Per-document access control                                                                      │   │
│   │   • User, group, and role-based permissions                                                         │   │
│   │   • Automatic filtering in search results                                                           │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    AUDIT & COMPLIANCE                                                │   │
│   │                                                                                                      │   │
│   │   All Actions Logged:                                                                                │   │
│   │   • Authentication events                                                                            │   │
│   │   • Document access                                                                                  │   │
│   │   • LLM queries and responses                                                                       │   │
│   │   • Admin actions                                                                                    │   │
│   │                                                                                                      │   │
│   │   Retention: 1 year (configurable)                                                                  │   │
│   │   Format: Structured JSON in PostgreSQL                                                             │   │
│   │   Export: On-demand for compliance audits                                                           │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                               │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Deployment Architecture

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                       DEPLOYMENT ARCHITECTURE                                                 │
├──────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    PRODUCTION (High Availability)                                    │   │
│   │                                                                                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │   │
│   │   │                              PRIMARY DATA CENTER (DC1)                                       │  │   │
│   │   │                                                                                              │  │   │
│   │   │   ┌────────────────────────────────────────────────────────────────────────────────────┐   │  │   │
│   │   │   │  GPU Cluster                                                                       │   │  │   │
│   │   │   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                                 │   │  │   │
│   │   │   │  │ Node 1  │ │ Node 2  │ │ Node 3  │ │ Node 4  │                                 │   │  │   │
│   │   │   │  │ 4xL40S  │ │ 4xL40S  │ │ 2xL40S  │ │ 2xL40S  │                                 │   │  │   │
│   │   │   │  │ (70B)   │ │ (70B)   │ │ (8B)    │ │ (spare) │                                 │   │  │   │
│   │   │   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘                                 │   │  │   │
│   │   │   └────────────────────────────────────────────────────────────────────────────────────┘   │  │   │
│   │   │                                                                                              │  │   │
│   │   │   ┌────────────────────────────────────────────────────────────────────────────────────┐   │  │   │
│   │   │   │  Application Cluster (K8s)                                                         │   │  │   │
│   │   │   │                                                                                    │   │  │   │
│   │   │   │   Gateway (3 replicas) │ Services (2+ replicas each) │ Workers (auto-scale)       │   │  │   │
│   │   │   └────────────────────────────────────────────────────────────────────────────────────┘   │  │   │
│   │   │                                                                                              │  │   │
│   │   │   ┌────────────────────────────────────────────────────────────────────────────────────┐   │  │   │
│   │   │   │  Data Cluster                                                                      │   │  │   │
│   │   │   │                                                                                    │   │  │   │
│   │   │   │   PostgreSQL (Primary) │ Redis Cluster │ MinIO (3-node) │ FAISS                   │   │  │   │
│   │   │   └────────────────────────────────────────────────────────────────────────────────────┘   │  │   │
│   │   │                                                                                              │  │   │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────────┘  │   │
│   │                                              │                                                      │   │
│   │                                    Streaming Replication                                            │   │
│   │                                              │                                                      │   │
│   │                                              ▼                                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │   │
│   │   │                              DR SITE (DC2) - Warm Standby                                     │  │   │
│   │   │                                                                                              │  │   │
│   │   │   • GPU Cluster (powered on, models loaded, not serving)                                    │  │   │
│   │   │   • PostgreSQL Replica (streaming)                                                          │  │   │
│   │   │   • FAISS (daily sync)                                                                      │  │   │
│   │   │   • MinIO (cross-region replication)                                                        │  │   │
│   │   │                                                                                              │  │   │
│   │   │   RTO: 4 hours │ RPO: 1 hour                                                                │  │   │
│   │   │                                                                                              │  │   │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────────┘  │   │
│   │                                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                               │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Operations Runbooks

### Model Deployment

```yaml
# Blue/Green Model Deployment
1. Pre-deployment:
   - Verify new model tested in staging
   - Check GPU memory requirements
   - Notify stakeholders

2. Deploy to GREEN:
   docker-compose -f docker-compose.green.yml up -d
   
3. Health Check:
   curl http://green:8002/health
   
4. Smoke Test:
   python scripts/smoke_test.py --endpoint http://green:8002

5. Canary (10%):
   update_load_balancer --green-weight 10

6. Monitor 30m:
   - Error rate < 1%
   - P99 latency < 2s
   - No GPU OOM

7. Full Cutover:
   update_load_balancer --green-weight 100

8. Keep BLUE 24h for rollback
```

### Incident Response

```yaml
# P1 Incident Runbook
1. Acknowledge alert (5 min SLA)

2. Initial Assessment:
   - Check Grafana dashboards
   - Review recent deployments
   - Check GPU health

3. Mitigation:
   - If model issue: Rollback to BLUE
   - If infrastructure: Engage platform team
   - If security: Isolate affected systems

4. Communication:
   - Update status page
   - Notify stakeholders in #incidents

5. Resolution & Post-mortem:
   - Document root cause
   - Create follow-up tickets
   - Update runbooks
```

---

## 5. Multi-Agent Orchestration

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         MULTI-AGENT ORCHESTRATION                                    │
│                                                                                      │
│   User Task: "Research AI trends and write a summary report"                        │
│        │                                                                             │
│        ▼                                                                             │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                         COORDINATOR AGENT                                     │  │
│   │                                                                               │  │
│   │   1. Analyze task                                                            │  │
│   │   2. Create execution plan                                                   │  │
│   │   3. Delegate to specialists                                                 │  │
│   │   4. Synthesize results                                                      │  │
│   │                                                                               │  │
│   └──────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                             │
│        │  Delegation (Hierarchical Pattern)                                         │
│        │                                                                             │
│        ├─────────────────────────────────────────────┐                              │
│        │                                             │                              │
│        ▼                                             ▼                              │
│   ┌──────────────────────┐                   ┌──────────────────────┐              │
│   │   RESEARCHER #1      │                   │   RESEARCHER #2      │              │
│   │                      │                   │                      │              │
│   │   Task: Search AI    │                   │   Task: Search       │              │
│   │   news 2024          │                   │   industry reports   │              │
│   │                      │                   │                      │              │
│   │   Tools:             │                   │   Tools:             │              │
│   │   • web_search       │                   │   • web_search       │              │
│   │   • url_fetcher      │                   │   • rag_query        │              │
│   │                      │                   │                      │              │
│   └──────────┬───────────┘                   └──────────┬───────────┘              │
│              │                                          │                          │
│              │         Research Results                 │                          │
│              │                                          │                          │
│              └──────────────────┬───────────────────────┘                          │
│                                 │                                                   │
│                                 ▼                                                   │
│   ┌──────────────────────────────────────────────────────────────────────────────┐ │
│   │                          ANALYST AGENT                                        │ │
│   │                                                                               │ │
│   │   Task: Analyze and synthesize findings                                      │ │
│   │   Tools: calculator, json_parser                                             │ │
│   │                                                                               │ │
│   └──────────────────────────────────────────────────────────────────────────────┘ │
│                                 │                                                   │
│                                 ▼                                                   │
│   ┌──────────────────────────────────────────────────────────────────────────────┐ │
│   │                          WRITER AGENT                                         │ │
│   │                                                                               │ │
│   │   Task: Write summary report                                                 │ │
│   │   Output: Formatted markdown report                                          │ │
│   │                                                                               │ │
│   └──────────────────────────────────────────────────────────────────────────────┘ │
│                                 │                                                   │
│                                 ▼                                                   │
│   ┌──────────────────────────────────────────────────────────────────────────────┐ │
│   │                          CRITIC AGENT                                         │ │
│   │                                                                               │ │
│   │   Task: Review and provide feedback                                          │ │
│   │   Output: Approved or revision requests                                      │ │
│   │                                                                               │ │
│   └──────────────────────────────────────────────────────────────────────────────┘ │
│                                 │                                                   │
│                                 ▼                                                   │
│                          FINAL OUTPUT                                               │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘

Collaboration Patterns:

┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ SEQUENTIAL  │     │  PARALLEL   │     │   DEBATE    │     │HIERARCHICAL │
│             │     │             │     │             │     │             │
│  A → B → C  │     │  A ──┬── D  │     │  A ↔ B ↔ C  │     │     C       │
│             │     │  B ──┤      │     │      │      │     │    /│\      │
│             │     │  C ──┘      │     │      ▼      │     │   A B D     │
│             │     │             │     │   Result    │     │             │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

---

## 6. Deployment Topology

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          DEPLOYMENT TOPOLOGY                                         │
│                          Production Configuration                                    │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         NETWORK LAYER                                        │   │
│   │                                                                              │   │
│   │   Internet ──▶ CloudFlare/WAF ──▶ Load Balancer (HA) ──▶ DMZ               │   │
│   │                                                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                               │
│   ════════════════════════════════════════════════════════════════════════════════  │
│                              FIREWALL (Allow 443 only)                              │
│   ════════════════════════════════════════════════════════════════════════════════  │
│                                      │                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                      APPLICATION ZONE (Node A/B)                             │   │
│   │                                                                              │   │
│   │   ┌───────────────────────────┐    ┌───────────────────────────┐           │   │
│   │   │        NODE A              │    │        NODE B              │           │   │
│   │   │                            │    │                            │           │   │
│   │   │  ┌──────────────────────┐ │    │  ┌──────────────────────┐ │           │   │
│   │   │  │  Gateway (x3)        │ │    │  │  Gateway (x3)        │ │           │   │
│   │   │  │  • FastAPI           │ │    │  │  • FastAPI           │ │           │   │
│   │   │  │  • Auth middleware   │ │    │  │  • Auth middleware   │ │           │   │
│   │   │  └──────────────────────┘ │    │  └──────────────────────┘ │           │   │
│   │   │                            │    │                            │           │   │
│   │   │  ┌──────────────────────┐ │    │  ┌──────────────────────┐ │           │   │
│   │   │  │  Services (x2 each)  │ │    │  │  Services (x2 each)  │ │           │   │
│   │   │  │  • RAG Service       │ │    │  │  • RAG Service       │ │           │   │
│   │   │  │  • Agent Service     │ │    │  │  • Agent Service     │ │           │   │
│   │   │  │  • Memory Service    │ │    │  │  • Memory Service    │ │           │   │
│   │   │  └──────────────────────┘ │    │  └──────────────────────┘ │           │   │
│   │   │                            │    │                            │           │   │
│   │   │  CPU: 32 cores            │    │  CPU: 32 cores            │           │   │
│   │   │  RAM: 128 GB              │    │  RAM: 128 GB              │           │   │
│   │   │                            │    │                            │           │   │
│   │   └───────────────────────────┘    └───────────────────────────┘           │   │
│   │                                                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                               │
│   ════════════════════════════════════════════════════════════════════════════════  │
│                              FIREWALL (Service accounts)                            │
│   ════════════════════════════════════════════════════════════════════════════════  │
│                                      │                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          GPU ZONE (Isolated)                                 │   │
│   │                                                                              │   │
│   │   ┌───────────────────────────┐    ┌───────────────────────────┐           │   │
│   │   │      GPU NODE 1           │    │      GPU NODE 2           │           │   │
│   │   │                           │    │                           │           │   │
│   │   │  ┌─────┐┌─────┐┌─────┐┌─────┐│  ┌─────┐┌─────┐           │           │   │
│   │   │  │L40S ││L40S ││L40S ││L40S ││  │L40S ││L40S │           │           │   │
│   │   │  │ 0   ││ 1   ││ 2   ││ 3   ││  │ 0   ││ 1   │           │           │   │
│   │   │  └─────┘└─────┘└─────┘└─────┘│  └─────┘└─────┘           │           │   │
│   │   │                           │    │                           │           │   │
│   │   │  vLLM: Llama-70B          │    │  vLLM: Llama-8B          │           │   │
│   │   │  Tensor Parallel: 4       │    │  Embeddings              │           │   │
│   │   │  Port: 8001               │    │  Port: 8002               │           │   │
│   │   │                           │    │                           │           │   │
│   │   └───────────────────────────┘    └───────────────────────────┘           │   │
│   │                                                                              │   │
│   │   NO INTERNET ACCESS │ NO EXTERNAL API CALLS                                │   │
│   │                                                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                               │
│   ════════════════════════════════════════════════════════════════════════════════  │
│                              FIREWALL (Encrypted only)                              │
│   ════════════════════════════════════════════════════════════════════════════════  │
│                                      │                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                            DATA ZONE                                         │   │
│   │                                                                              │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │   │
│   │   │ PostgreSQL  │  │   FAISS     │  │   Redis     │  │   MinIO     │       │   │
│   │   │  Primary    │  │  Indexes    │  │  Cluster    │  │  Storage    │       │   │
│   │   │  + Replica  │  │             │  │             │  │             │       │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │   │
│   │                                                                              │   │
│   │   ENCRYPTED AT REST │ DAILY BACKUPS │ STREAMING REPLICATION                 │   │
│   │                                                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. RBAC + ACL Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              RBAC + ACL AUTHORIZATION FLOW                           │
│                                                                                      │
│   User Request                                                                       │
│        │                                                                             │
│        ▼                                                                             │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                        STEP 1: AUTHENTICATION                                 │  │
│   │                                                                               │  │
│   │   JWT Token ──▶ Validate ──▶ Extract Claims                                  │  │
│   │                                 │                                             │  │
│   │                                 ▼                                             │  │
│   │                         ┌─────────────────┐                                  │  │
│   │                         │  User Context   │                                  │  │
│   │                         │                 │                                  │  │
│   │                         │  user_id: abc   │                                  │  │
│   │                         │  tenant: acme   │                                  │  │
│   │                         │  role: user     │                                  │  │
│   │                         │  groups: [eng]  │                                  │  │
│   │                         │                 │                                  │  │
│   │                         └─────────────────┘                                  │  │
│   │                                                                               │  │
│   └──────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                             │
│        ▼                                                                             │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                        STEP 2: RBAC CHECK                                     │  │
│   │                                                                               │  │
│   │   Endpoint: POST /api/v1/rag/query                                           │  │
│   │   Required Permission: rag:query                                             │  │
│   │                                                                               │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                    PERMISSION MATRIX                                 │   │  │
│   │   │                                                                      │   │  │
│   │   │   Role: user                                                        │   │  │
│   │   │   Permissions:                                                      │   │  │
│   │   │     ✅ rag:query                                                    │   │  │
│   │   │     ✅ llm:generate                                                 │   │  │
│   │   │     ✅ agents:run                                                   │   │  │
│   │   │     ❌ rag:ingest                                                   │   │  │
│   │   │     ❌ admin:*                                                      │   │  │
│   │   │                                                                      │   │  │
│   │   │   Result: ✅ RBAC PASSED                                            │   │  │
│   │   │                                                                      │   │  │
│   │   └─────────────────────────────────────────────────────────────────────┘   │  │
│   │                                                                               │  │
│   └──────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                             │
│        ▼                                                                             │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                        STEP 3: DOCUMENT ACL CHECK                             │  │
│   │                                                                               │  │
│   │   Documents Retrieved: [doc-123, doc-456, doc-789]                           │  │
│   │                                                                               │  │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                    ACL EVALUATION                                    │   │  │
│   │   │                                                                      │   │  │
│   │   │   doc-123:                                                          │   │  │
│   │   │     visibility: tenant                                              │   │  │
│   │   │     user.tenant == doc.tenant? ✅ YES                               │   │  │
│   │   │     Result: ✅ ALLOWED                                              │   │  │
│   │   │                                                                      │   │  │
│   │   │   doc-456:                                                          │   │  │
│   │   │     visibility: group                                               │   │  │
│   │   │     ACL: group:finance ──▶ read                                     │   │  │
│   │   │     user in group:finance? ❌ NO                                    │   │  │
│   │   │     Result: ❌ DENIED                                               │   │  │
│   │   │                                                                      │   │  │
│   │   │   doc-789:                                                          │   │  │
│   │   │     visibility: private                                             │   │  │
│   │   │     ACL: user:abc ──▶ read                                          │   │  │
│   │   │     user == user:abc? ✅ YES                                        │   │  │
│   │   │     Result: ✅ ALLOWED                                              │   │  │
│   │   │                                                                      │   │  │
│   │   └─────────────────────────────────────────────────────────────────────┘   │  │
│   │                                                                               │  │
│   │   Filtered Results: [doc-123, doc-789]  (doc-456 removed)                    │  │
│   │                                                                               │  │
│   └──────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                             │
│        ▼                                                                             │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                        STEP 4: AUDIT LOG                                      │  │
│   │                                                                               │  │
│   │   {                                                                          │  │
│   │     "event": "data.document.read",                                          │  │
│   │     "user_id": "abc",                                                       │  │
│   │     "documents_requested": ["doc-123", "doc-456", "doc-789"],               │  │
│   │     "documents_granted": ["doc-123", "doc-789"],                            │  │
│   │     "documents_denied": ["doc-456"],                                        │  │
│   │     "deny_reason": "acl_group_mismatch"                                     │  │
│   │   }                                                                          │  │
│   │                                                                               │  │
│   └──────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                             │
│        ▼                                                                             │
│   Response with Filtered Documents                                                   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Monitoring Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              MONITORING PIPELINE                                     │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                              DATA SOURCES                                    │   │
│   │                                                                              │   │
│   │   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │   │
│   │   │ Gateway │ │   RAG   │ │ Agents  │ │  vLLM   │ │Postgres │ │  GPUs   │ │   │
│   │   │ /metrics│ │ /metrics│ │ /metrics│ │ /metrics│ │Exporter │ │  DCGM   │ │   │
│   │   └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ │   │
│   │        │           │           │           │           │           │       │   │
│   │        └───────────┴───────────┴───────────┴───────────┴───────────┘       │   │
│   │                                    │                                        │   │
│   └────────────────────────────────────┼────────────────────────────────────────┘   │
│                                        │                                             │
│                                        ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                           PROMETHEUS                                         │   │
│   │                                                                              │   │
│   │   Scrape Interval: 15s (services), 5s (GPU)                                 │   │
│   │   Retention: 30 days                                                        │   │
│   │   Storage: 100GB SSD                                                        │   │
│   │                                                                              │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │   │
│   │   │                     Recording Rules                                  │  │   │
│   │   │                                                                      │  │   │
│   │   │   goai:http_requests:rate5m                                         │  │   │
│   │   │   goai:http_errors:rate5m                                           │  │   │
│   │   │   goai:http_latency:p99                                             │  │   │
│   │   │   goai:llm_tokens:rate5m                                            │  │   │
│   │   │   goai:gpu_utilization:avg                                          │  │   │
│   │   │                                                                      │  │   │
│   │   └─────────────────────────────────────────────────────────────────────┘  │   │
│   │                                                                              │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐  │   │
│   │   │                      Alert Rules                                     │  │   │
│   │   │                                                                      │  │   │
│   │   │   CRITICAL:                                                         │  │   │
│   │   │     • ServiceDown                                                   │  │   │
│   │   │     • GPUMemoryExhausted                                            │  │   │
│   │   │     • LLMQueueOverload                                              │  │   │
│   │   │                                                                      │  │   │
│   │   │   WARNING:                                                          │  │   │
│   │   │     • HighLatency                                                   │  │   │
│   │   │     • HighErrorRate                                                 │  │   │
│   │   │     • LowCacheHitRate                                               │  │   │
│   │   │                                                                      │  │   │
│   │   └─────────────────────────────────────────────────────────────────────┘  │   │
│   │                                                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                    │                                              │                  │
│                    ▼                                              ▼                  │
│   ┌─────────────────────────────┐              ┌─────────────────────────────┐      │
│   │       ALERTMANAGER          │              │         GRAFANA             │      │
│   │                             │              │                             │      │
│   │   Routes:                   │              │   Dashboards:               │      │
│   │   • Critical → PagerDuty   │              │   • System Overview         │      │
│   │   • Critical → Slack #crit  │              │   • LLM Performance        │      │
│   │   • Warning → Slack #alerts │              │   • GPU Metrics            │      │
│   │   • Info → Email digest     │              │   • RAG Performance        │      │
│   │                             │              │   • Alert Overview         │      │
│   │                             │              │                             │      │
│   └──────────────┬──────────────┘              └─────────────────────────────┘      │
│                  │                                                                   │
│                  ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                           NOTIFICATION CHANNELS                              │   │
│   │                                                                              │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │   │
│   │   │  PagerDuty  │  │    Slack    │  │   Email     │  │   Webhook   │       │   │
│   │   │  (On-Call)  │  │  (Teams)    │  │  (Reports)  │  │  (Custom)   │       │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │   │
│   │                                                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ═══════════════════════════════════════════════════════════════════════════════   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                           LOG PIPELINE                                       │   │
│   │                                                                              │   │
│   │   Applications ──▶ Promtail ──▶ Loki ──▶ Grafana (Explore)                  │   │
│   │                                                                              │   │
│   │   Log Types:                                                                │   │
│   │   • audit_log      (7 years retention)                                      │   │
│   │   • retrieval_log  (1 year retention)                                       │   │
│   │   • action_log     (90 days retention)                                      │   │
│   │   • model_log      (30 days retention)                                      │   │
│   │                                                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Performance Tuning

### vLLM Optimization

```yaml
# Optimal vLLM settings for Llama-70B on 4x L40S
--tensor-parallel-size 4          # Shard across 4 GPUs
--gpu-memory-utilization 0.95     # Use 95% GPU memory
--max-model-len 8192              # Context length
--dtype bfloat16                  # Precision
--enable-prefix-caching           # Cache common prefixes
--max-num-batched-tokens 32768    # Batch size
```

### PostgreSQL Tuning

```sql
-- postgresql.conf optimizations
shared_buffers = 8GB              -- 25% of RAM
work_mem = 256MB
maintenance_work_mem = 1GB
effective_cache_size = 24GB
random_page_cost = 1.1            -- SSD
```

### FAISS Tuning

```python
# Optimal FAISS settings for 500K vectors
index = faiss.index_factory(
    1024,                          # Dimensions
    "IVF4096,PQ64",               # Index type
    faiss.METRIC_INNER_PRODUCT    # Cosine similarity
)
index.nprobe = 128                # Search clusters
```

---

**GoAI Sovereign AI Platform v1** — Technical Architecture Reference 🏛️
